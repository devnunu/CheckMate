# .github/workflows/ai-interactive-response.yml
name: AI Interactive Response

on:
  issue_comment:
    types: [created]
  pull_request_review_comment:
    types: [created]

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  ai-response:
    # AIê°€ ìƒì„±í•œ ì½”ë©˜íŠ¸ì— ëŒ€í•œ ì‚¬ìš©ì ì‘ë‹µë§Œ ì²˜ë¦¬
    if: |
      github.event_name == 'issue_comment' || 
      github.event_name == 'pull_request_review_comment'

    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install openai requests PyGithub

      - name: Check if should respond
        id: should-respond
        uses: actions/github-script@v7
        with:
          script: |
            // AI ë´‡ ìì‹ ì˜ ì½”ë©˜íŠ¸ëŠ” ë¬´ì‹œ
            if (context.payload.comment.user.login === 'github-actions[bot]') {
              console.log('AI ë´‡ ìì‹ ì˜ ì½”ë©˜íŠ¸, ë¬´ì‹œ');
              core.setOutput('should_respond', 'false');
              return;
            }
            
            // ë„ˆë¬´ ì§§ì€ ì½”ë©˜íŠ¸ëŠ” ë¬´ì‹œ (5ì ì´í•˜)
            const commentBody = context.payload.comment.body.trim();
            if (commentBody.length <= 5) {
              console.log('ë„ˆë¬´ ì§§ì€ ì½”ë©˜íŠ¸, ë¬´ì‹œ');
              core.setOutput('should_respond', 'false');
              return;
            }
            
            // ë‹¨ìˆœí•œ íŒ¨í„´ë“¤ ë¬´ì‹œ
            const ignorePatterns = [
              /^(ê°ì‚¬|ê³ ë§ˆì›Œ|thanks|thx)\s*$/i,
              /^(ok|okay|ì¢‹ì•„|ì•Œê² )\s*$/i,
              /^\s*\+1\s*$/,
              /^\s*ğŸ‘\s*$/,
              /^\s*âœ…\s*$/
            ];
            
            for (const pattern of ignorePatterns) {
              if (pattern.test(commentBody)) {
                console.log('ë‹¨ìˆœí•œ íŒ¨í„´ ë§¤ì¹˜, ë¬´ì‹œ');
                core.setOutput('should_respond', 'false');
                return;
              }
            }
            
            console.log('ì‘ë‹µ ê°€ëŠ¥í•œ ì½”ë©˜íŠ¸ë¡œ íŒë‹¨');
            core.setOutput('should_respond', 'true');

      - name: Add thinking reaction
        if: steps.should-respond.outputs.should_respond == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            try {
              await github.rest.reactions.createForIssueComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: context.payload.comment.id,
                content: 'eyes'  // ğŸ‘€ ë¦¬ì•¡ì…˜ (ìƒê° ì¤‘)
              });
            } catch (error) {
              console.log('ë¦¬ì•¡ì…˜ ì¶”ê°€ ì‹¤íŒ¨:', error.message);
            }

      - name: Run Interactive AI Response
        if: steps.should-respond.outputs.should_respond == 'true'
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO_NAME: ${{ github.repository }}
          COMMENT_ID: ${{ github.event.comment.id }}
          COMMENT_BODY: ${{ github.event.comment.body }}
          COMMENT_AUTHOR: ${{ github.event.comment.user.login }}
        run: |
          python .github/scripts/interactive_ai_responder.py

      - name: Add completion reaction
        if: steps.should-respond.outputs.should_respond == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            try {
              // ìƒê° ì¤‘ ë¦¬ì•¡ì…˜ ì œê±° (ê°€ëŠ¥í•œ ê²½ìš°)
              await github.rest.reactions.deleteForIssueComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: context.payload.comment.id,
                content: 'eyes'
              }).catch(() => {}); // ì‹¤íŒ¨í•´ë„ ë¬´ì‹œ
            
              // ì™„ë£Œ ë¦¬ì•¡ì…˜ ì¶”ê°€
              await github.rest.reactions.createForIssueComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: context.payload.comment.id,
                content: 'rocket'  // ğŸš€ ë¦¬ì•¡ì…˜ (ì™„ë£Œ)
              });
            } catch (error) {
              console.log('ë¦¬ì•¡ì…˜ ì²˜ë¦¬ ì‹¤íŒ¨:', error.message);
            }
